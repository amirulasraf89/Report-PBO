<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<title>Inspection Form — 45 Fields (UPPERCASE)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    /* Global Styles for Responsiveness */
    body { 
        font-family: Arial, sans-serif; 
        padding: 10px;
        max-width: 900px; 
        margin: auto; 
    }
    
    /* Ensure form elements are readable and full width */
    label { 
        font-weight: 600; 
        display: block; 
        margin-top: 15px;
        margin-bottom: 3px;
    }
    input, select, textarea { 
        width: 100%; 
        padding: 12px;
        margin: 4px 0; 
        box-sizing: border-box; 
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        /* >>> PERUBAHAN UTAMA UNTUK HURUF BESAR <<< */
        **text-transform: uppercase;** }
    textarea { 
        min-height: 80px;
        resize: vertical; 
    }

    /* Button Styles */
    .buttons { 
        margin-top: 20px; 
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    button { 
        padding: 12px;
        width: 100%;
        margin: 0;
        cursor: pointer; 
        font-size: 16px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
    }
    button:hover {
        background-color: #0056b3;
    }
    
    /* Saved List Styles */
    .row-box { 
        background: #f7f7f7; 
        padding: 10px; 
        margin-top: 8px; 
        border-radius: 6px; 
        border: 1px solid #eee;
        /* >>> PERUBAHAN UTAMA UNTUK HURUF BESAR PADA OUTPUT TERSIMPAN <<< */
        **text-transform: uppercase;** }
    .row-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        cursor: pointer; 
        gap: 12px; 
        flex-wrap: wrap;
    }
    .row-left { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        flex-basis: auto; 
        min-width: 0;
    }
    .arrow { 
        width: 20px; 
        display: inline-block; 
        text-align: center; 
        flex-shrink: 0;
    }
    .edit-btn { 
        padding: 8px 12px;
        font-size: 14px;
        flex-shrink: 0;
    }
    .details { 
        background: #fff; 
        margin-top: 10px; 
        padding: 10px; 
        border-radius: 6px; 
        display: none; 
        white-space: pre-wrap; 
        border: 1px solid #ddd;
    }
    .field-line { 
        margin-bottom: 8px; 
        padding-bottom: 4px;
        border-bottom: 1px dotted #eee;
    }
    .small { 
        font-size: 0.9em; 
        color: #555; 
        display: block;
    }

    /* Media Query for Larger Screens (Desktop/Tablet) */
    @media (min-width: 600px) {
        .buttons {
            flex-direction: row;
        }
        button {
            width: auto;
        }
        .row-header {
            flex-wrap: nowrap;
        }
    }

</style>
</head>
<body>

<h2>INSPECTION FORM — 45 FIELDS</h2>

<div id="formArea">
    <label>NO (AUTO):</label>
    <input type="text" id="no" readonly>

    <label>1. INSPECTION DATE</label>
    <input type="date" id="inspection_date">

    <label>2. INSPECTION TIME</label>
    <input type="time" id="inspection_time">

    <label>3. TARIKH SERAHAN NOTIS PEMOTONGAN</label>
    <input type="date" id="notis_date">

    <label>4. STATE</label>
<select id="state">
    <option value="">-- SELECT STATE --</option>
    <option value="Johor">JOHOR</option>
    <option value="Kedah">KEDAH</option>
    <option value="Kelantan">KELANTAN</option>
    <option value="Melaka">MELAKA</option>
    <option value="Negeri Sembilan">NEGERI SEMBILAN</option>
    <option value="Pahang">PAHANG</option>
    <option value="Pulau Pinang">PULAU PINANG</option>
    <option value="Perak">PERAK</option>
    <option value="Perlis">PERLIS</option>
    <option value="Sabah">SABAH</option>
    <option value="Sarawak">SARAWAK</option>
    <option value="Selangor">SELANGOR</option>
    <option value="Terengganu">TERENGGANU</option>
    <option value="W.P. Kuala Lumpur">W.P. KUALA LUMPUR</option>
    <option value="W.P. Putrajaya">W.P. PUTRAJAYA</option>
    <option value="W.P. Labuan">W.P. LABUAN</option>
</select>

    <label>5. STATION CODE</label>
    <input type="text" id="station_code">

    <label>6. CONTRACT ACCOUNT NO.</label>
    <input type="text" id="contract_account_no">

    <label>7. CUSTOMER NAME</label>
    <input type="text" id="customer_name">

    <label>8. CUSTOMER TYPE</label>
    <input type="text" id="customer_type">

    <label>9. TARIFF</label>
    <input type="text" id="tariff">

    <label>10. PREMISE ADDRESS</label>
    <textarea id="premise_address"></textarea>

    <label>11. ANOMALY (TYPE)</label>
    <input type="text" id="anomaly_type">

    <label>12. INSTALLATION NO.</label>
    <input type="text" id="installation_no">

    <label>13. GPS COORDINATE</label>
    <input type="text" id="gps_coordinate" placeholder="LAT, LONG">

    <label>14. MANUFACT NO.</label>
    <input type="text" id="manufact_no">

    <label>15. METER BRAND</label>
    <input type="text" id="meter_brand">

    <label>16. METER DESCRIPTION</label>
    <input type="text" id="meter_description">

    <label>17. CT RATIO</label>
    <input type="text" id="ct_ratio">

    <label>18. METER INSTALLATION DATE</label>
    <input type="date" id="meter_installation_date">

    <label>19. ERROR</label>
    <input type="text" id="error_field">

    <label>20. TESTING METHOD</label>
    <input type="text" id="testing_method">

    <label>21. TECHNICAL ACTION</label>
    <input type="text" id="technical_action">

    <label>22. REPLACE METER MANUFACT NO.</label>
    <input type="text" id="replace_manufact_no">

    <label>23. REPLACE METER BRAND</label>
    <input type="text" id="replace_meter_brand">

    <label>24. METER CATEGORY</label>
    <input type="text" id="meter_category">

    <label>25. REMARKS</label>
    <textarea id="remarks"></textarea>

    <label>26. JENIS PREMIS</label>
    <input type="text" id="jenis_premis">

    <label>27. CAUSE</label>
    <input type="text" id="cause">

    <label>28. ACTION CAMERA</label>
    <input type="text" id="action_camera">

    <label>29. SERVICE REQUEST ID</label>
    <input type="text" id="service_request_id">

    <label>30. PROJECT TYPE</label>
    <input type="text" id="project_type">

    <label>31. HRC</label>
    <input type="text" id="hrc">

    <label>32. METER SEND TO LAB</label>
    <input type="text" id="meter_send_to_lab">

    <label>33. METER CHANGED STATUS</label>
    <input type="text" id="meter_changed_status">

    <label>34. NO OF TEAM</label>
    <input type="number" id="no_of_team" min="0">

    <label>35. TEAM LEADER</label>
    <input type="text" id="team_leader">

    <label>36. TEAM MEMBER 1</label>
    <input type="text" id="team_member_1">

    <label>37. TEAM MEMBER 2</label>
    <input type="text" id="team_member_2">

    <label>38. TEAM MEMBER 3</label>
    <input type="text" id="team_member_3">

    <label>39. CASE ID NO</label>
    <input type="text" id="case_id_no">

    <label>40. SERVICE NOTIFICATION (S/N) NO</label>
    <input type="text" id="service_notification_no">

    <label>41. INSPECTION RESULT</label>
    <input type="text" id="inspection_result">

    <label>42. DISCONNECTION DATE</label>
    <input type="date" id="disconnection_date">

    <label>43. STATUS</label>
    <input type="text" id="status_field">

    <label>44. TESTING METHOD (REMARKS)</label>
    <textarea id="testing_method_remarks"></textarea>

    <div class="buttons">
        <button onclick="saveEntry()">SAVE ENTRY</button>
        <button onclick="downloadExcel()">DOWNLOAD EXCEL</button>
        <button onclick="clearSaved()">CLEAR SAVED LIST</button>
    </div>
</div>

<h3>DATA SAVED:</h3>
<div id="savedList"></div>

<script>
/* --- data store --- */
let entries = [];
let editingIndex = null;

/* --- on load: restore from localStorage --- */
window.onload = function() {
    const saved = localStorage.getItem("inspection_data_45");
    if (saved) {
        entries = JSON.parse(saved);
        renderList();
    }
    updateAutoNumber();
};

/* --- helper: all field ids in correct order for Excel / storage --- */
const fieldIds = [
  "no",
  "inspection_date",
  "inspection_time",
  "notis_date",
  "state",
  "station_code",
  "contract_account_no",
  "customer_name",
  "customer_type",
  "tariff",
  "premise_address",
  "anomaly_type",
  "installation_no",
  "gps_coordinate",
  "manufact_no",
  "meter_brand",
  "meter_description",
  "ct_ratio",
  "meter_installation_date",
  "error_field",
  "testing_method",
  "technical_action",
  "replace_manufact_no",
  "replace_meter_brand",
  "meter_category",
  "remarks",
  "jenis_premis",
  "cause",
  "action_camera",
  "service_request_id",
  "project_type",
  "hrc",
  "meter_send_to_lab",
  "meter_changed_status",
  "no_of_team",
  "team_leader",
  "team_member_1",
  "team_member_2",
  "team_member_3",
  "case_id_no",
  "service_notification_no",
  "inspection_result",
  "disconnection_date",
  "status_field",
  "testing_method_remarks"
];

/* --- update No field shown in form --- */
function updateAutoNumber() {
    document.getElementById("no").value = editingIndex !== null ? entries[editingIndex].no : entries.length + 1;
}

/* --- read form into object --- */
function readForm() {
    const obj = {};
    fieldIds.forEach(id => {
        const el = document.getElementById(id);
        let value = el ? el.value : "";
        
        // Simpan nilai dalam huruf besar untuk memastikan konsistensi data
        if (typeof value === 'string') {
            value = value.toUpperCase();
        }
        obj[id] = value;
    });
    return obj;
}

/* --- write object into form (for edit) --- */
function writeForm(obj) {
    fieldIds.forEach(id => {
        const el = document.getElementById(id);
        // Pastikan tarikh kekal dalam format yang betul untuk input[type="date"]
        if (el) {
            if (el.type === 'date' || el.type === 'time') {
                 el.value = obj[id] || "";
            } else {
                 // Apabila mengisi borang, pastikan data yang disimpan (yang kini adalah UPPERCASE) dipaparkan
                 el.value = obj[id] || "";
            }
        }
    });
}

/* --- clear all form fields except NO gets auto updated after clear --- */
function clearForm() {
    fieldIds.forEach(id => {
        if (id !== "no") {
            const el = document.getElementById(id);
            if (el) el.value = "";
        }
    });
    editingIndex = null;
    updateAutoNumber();
}

/* --- save entry (new or update) --- */
function saveEntry() {
    const entry = readForm();

    // ensure No is string or number - keep whatever stored
    if (editingIndex !== null) {
        entries[editingIndex] = entry;
        editingIndex = null;
    } else {
        // set no as entries.length+1 (string)
        entry.no = String(entries.length + 1);
        entries.push(entry);
    }

    persist();
    renderList();
    clearForm();
}

/* --- persist to localStorage --- */
function persist() {
    localStorage.setItem("inspection_data_45", JSON.stringify(entries));
}

/* --- render saved list with expand/collapse and edit button --- */
function renderList() {
    const container = document.getElementById("savedList");
    let html = "";

    entries.forEach((e, i) => {
        // build details display — show label: value pairs
        let detailsHtml = "";
        // start from index 1 because fieldIds[0] is 'no' and already visible
        for (let j = 1; j < fieldIds.length; j++) {
            const id = fieldIds[j];
            const labelText = getLabelById(id);
            const value = e[id] !== undefined && e[id] !== "" ? e[id] : "—";
            detailsHtml += `<div class="field-line"><span class="small"><b>${labelText}:</b></span> ${escapeHtml(value)}</div>`;
        }

        html += `
        <div class="row-box">
            <div class="row-header" onclick="toggleDetails(${i})">
                <div class="row-left">
                    <span class="arrow" id="arrow_${i}">▶</span>
                    <div><b>${escapeHtml(e.no || String(i+1))}</b> — ${escapeHtml(e.customer_name || "(NO NAME)")}</div>
                </div>
                <div>
                    <button class="edit-btn" onclick="event.stopPropagation(); editEntry(${i});">EDIT</button>
                </div>
            </div>

            <div class="details" id="detail_${i}">
                ${detailsHtml}
            </div>
        </div>`;
    });

    container.innerHTML = html;
    updateAutoNumber();
}

/* --- mapping id -> readable label (keeps original order) --- */
function getLabelById(id) {
    const labels = {
        "inspection_date":"INSPECTION DATE",
        "inspection_time":"INSPECTION TIME",
        "notis_date":"TARIKH SERAHAN NOTIS PEMOTONGAN",
        "state":"STATE",
        "station_code":"STATION CODE",
        "contract_account_no":"CONTRACT ACCOUNT NO.",
        "customer_name":"CUSTOMER NAME",
        "customer_type":"CUSTOMER TYPE",
        "tariff":"TARIFF",
        "premise_address":"PREMISE ADDRESS",
        "anomaly_type":"ANOMALY (TYPE)",
        "installation_no":"INSTALLATION NO.",
        "gps_coordinate":"GPS COORDINATE",
        "manufact_no":"MANUFACT NO.",
        "meter_brand":"METER BRAND",
        "meter_description":"METER DESCRIPTION",
        "ct_ratio":"CT RATIO",
        "meter_installation_date":"METER INSTALLATION DATE",
        "error_field":"ERROR",
        "testing_method":"TESTING METHOD",
        "technical_action":"TECHNICAL ACTION",
        "replace_manufact_no":"REPLACE METER MANUFACT NO.",
        "replace_meter_brand":"REPLACE METER BRAND",
        "meter_category":"METER CATEGORY",
        "remarks":"REMARKS",
        "jenis_premis":"JENIS PREMIS",
        "cause":"CAUSE",
        "action_camera":"ACTION CAMERA",
        "service_request_id":"SERVICE REQUEST ID",
        "project_type":"PROJECT TYPE",
        "hrc":"HRC",
        "meter_send_to_lab":"METER SEND TO LAB",
        "meter_changed_status":"METER CHANGED STATUS",
        "no_of_team":"NO OF TEAM",
        "team_leader":"TEAM LEADER",
        "team_member_1":"TEAM MEMBER 1",
        "team_member_2":"TEAM MEMBER 2",
        "team_member_3":"TEAM MEMBER 3",
        "case_id_no":"CASE ID NO",
        "service_notification_no":"SERVICE NOTIFICATION (S/N) NO",
        "inspection_result":"INSPECTION RESULT",
        "disconnection_date":"DISCONNECTION DATE",
        "status_field":"STATUS",
        "testing_method_remarks":"TESTING METHOD (REMARKS)"
    };
    return labels[id] || id.toUpperCase();
}

/* --- toggle expand / collapse details --- */
function toggleDetails(index) {
    const detail = document.getElementById("detail_" + index);
    const arrow = document.getElementById("arrow_" + index);
    if (!detail) return;
    if (detail.style.display === "block") {
        detail.style.display = "none";
        if (arrow) arrow.textContent = "▶";
    } else {
        detail.style.display = "block";
        if (arrow) arrow.textContent = "▼";
    }
}

/* --- edit entry: load into form and set editingIndex --- */
function editEntry(index) {
    editingIndex = index;
    const obj = entries[index];
    if (!obj) return;
    writeForm(obj);
    // ensure NO shows the stored no and not auto incremented
    document.getElementById("no").value = obj.no || String(index + 1);
    // scroll to top so user sees the form
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* --- clear saved entries --- */
function clearSaved() {
    if (!confirm("CLEAR ALL SAVED ENTRIES?")) return;
    entries = [];
    localStorage.removeItem("inspection_data_45");
    renderList();
}

/* --- download Excel with all 45 columns --- */
function downloadExcel() {
    const wb = XLSX.utils.book_new();

    // Headers in the same order as you requested (1..45)
    const headers = [
      "NO",
      "INSPECTION DATE",
      "INSPECTION TIME",
      "TARIKH SERAHAN NOTIS PEMOTONGAN",
      "STATE",
      "STATION CODE",
      "CONTRACT ACCOUNT NO.",
      "CUSTOMER NAME",
      "CUSTOMER TYPE",
      "TARIFF",
      "PREMISE ADDRESS",
      "ANOMALY (TYPE)",
      "INSTALLATION NO.",
      "GPS COORDINATE",
      "MANUFACT NO.",
      "METER BRAND",
      "METER DESCRIPTION",
      "CT RATIO",
      "METER INSTALLATION DATE",
      "ERROR",
      "TESTING METHOD",
      "TECHNICAL ACTION",
      "REPLACE METER MANUFACT NO.",
      "REPLACE METER BRAND",
      "METER CATEGORY",
      "REMARKS",
      "JENIS PREMIS",
      "CAUSE",
      "ACTION CAMERA",
      "SERVICE REQUEST ID",
      "PROJECT TYPE",
      "HRC",
      "METER SEND TO LAB",
      "METER CHANGED STATUS",
      "NO OF TEAM",
      "TEAM LEADER",
      "TEAM MEMBER 1",
      "TEAM MEMBER 2",
      "TEAM MEMBER 3",
      "CASE ID NO",
      "SERVICE NOTIFICATION (S/N) NO",
      "INSPECTION RESULT",
      "DISCONNECTION DATE",
      "STATUS",
      "TESTING METHOD (REMARKS)"
    ];

    const ws_data = [headers];

    entries.forEach(e => {
        // Data is already stored in uppercase due to readForm modification
        const row = fieldIds.map(id => e[id] !== undefined ? e[id] : "");
        ws_data.push(row);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    ws["!ref"] = "A1:" + XLSX.utils.encode_cell({ c: headers.length - 1, r: ws_data.length - 1 });
    XLSX.utils.book_append_sheet(wb, ws, "SHEET1");
    XLSX.writeFile(wb, "INSPECTION_DATA_45.XLSX");
}

/* --- utility: escape HTML to avoid injection in display (safe) --- */
function escapeHtml(text) {
    if (!text && text !== 0) return "";
    return String(text)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
}
</script>

</body>
</html>
